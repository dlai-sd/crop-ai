name: Mobile CI - Lint, Test, Build APK

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'mobile/**'

jobs:
  build:
    name: Build, Lint, Test, and Package APK
    runs-on: ubuntu-latest
    
    outputs:
      apk_path: ${{ steps.build_apk.outputs.apk_path }}
      build_status: ${{ job.status }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Debug - Check environment
        run: |
          echo "Dart SDK version:"
          which dart
          dart --version
          echo "Flutter version:"
          which flutter
          flutter --version

      - name: Setup Android Build (local.properties)
        working-directory: ./mobile
        run: |
          echo "Creating android/local.properties..."
          FLUTTER_ROOT=$(dirname $(dirname $(which flutter)))
          ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          mkdir -p android
          echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties
          echo "sdk.dir=$ANDROID_SDK_ROOT" >> android/local.properties
          echo "✓ Created android/local.properties with:"
          cat android/local.properties

      - name: Cache Flutter pub cache
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('mobile/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache Flutter build
        uses: actions/cache@v3
        with:
          path: mobile/build
          key: ${{ runner.os }}-flutter-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-

      - name: Get Flutter dependencies
        working-directory: ./mobile
        run: |
          echo "Removing stale pubspec.lock if exists..."
          rm -f pubspec.lock
          echo "Running flutter pub get..."
          flutter pub get --verbose 2>&1 | tee pub-get.log
          PUB_RESULT=$?
          if [ $PUB_RESULT -ne 0 ]; then
            echo "ERROR: flutter pub get failed with exit code $PUB_RESULT"
            exit $PUB_RESULT
          fi
          echo "✓ Dependencies resolved successfully"

      - name: Generate code (build_runner)
        working-directory: ./mobile
        run: |
          echo "Starting code generation..."
          dart run build_runner build --delete-conflicting-outputs --verbose 2>&1 | tee build_runner.log
          echo "Code generation completed"

      - name: Analyze code
        working-directory: ./mobile
        run: |
          echo "Running Flutter analyzer..."
          flutter analyze --no-fatal-infos 2>&1 | tee analyzer.log || true
          echo "Analyzer complete"
        continue-on-error: true

      - name: Check formatting
        working-directory: ./mobile
        run: dart format --set-exit-if-changed lib test
        continue-on-error: true

      - name: Run unit tests
        working-directory: ./mobile
        run: |
          if [ -d "test" ] && [ "$(find test -name '*_test.dart' -type f | grep -v placeholder)" ]; then
            echo "Running tests..."
            flutter test --coverage 2>&1 | tee test.log
          else
            echo "No real tests found, skipping test execution"
          fi
        continue-on-error: true

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./mobile/coverage/lcov.info
          flags: mobile
          name: mobile-coverage
        continue-on-error: true

      - name: Build APK (release) - ARM64
        id: build_apk
        working-directory: ./mobile
        run: |
          echo "========== APK BUILD START =========="
          echo "Flutter version:"
          flutter --version
          echo ""
          echo "Verifying local.properties was created:"
          if [ -f "android/local.properties" ]; then
            echo "✓ local.properties exists"
            cat android/local.properties
          else
            echo "✗ ERROR: local.properties not found!"
            exit 1
          fi
          echo ""
          echo "Checking gradlew:"
          ls -lh android/gradlew 2>/dev/null || echo "No gradlew found"
          echo ""
          echo "Starting Flutter build APK with detailed output..."
          flutter build apk \
            --release \
            --target-platform android-arm64 \
            -v 2>&1 | tee build.log
          BUILD_RESULT=$?
          echo ""
          echo "Build exit code: $BUILD_RESULT"
          if [ $BUILD_RESULT -ne 0 ]; then
            echo "ERROR: Build failed with code $BUILD_RESULT"
            echo "Last 50 lines of build.log:"
            tail -50 build.log
            exit $BUILD_RESULT
          fi
          echo ""
          echo "Checking build output directory after successful build:"
          if [ -d "build/app/outputs/flutter-apk/" ]; then
            echo "✓ flutter-apk directory exists"
            ls -lah build/app/outputs/flutter-apk/
          else
            echo "✗ ERROR: flutter-apk directory not found"
            echo "Contents of build/app/outputs/:"
            ls -laR build/app/outputs/ 2>/dev/null || echo "No outputs directory"
          fi
          echo ""
          echo "Searching for any APK files in entire build dir:"
          find build -name "*.apk" -type f 2>/dev/null | head -10 || echo "No APK files found"
          echo "========== APK BUILD END =========="
          echo "apk_path=build/app/outputs/flutter-apk/app-release.apk" >> $GITHUB_OUTPUT

      - name: Verify APK
        working-directory: ./mobile
        run: |
          echo "Checking for APK files..."
          echo ""
          echo "Listing entire build directory structure:"
          find build -type f -name "*.apk" 2>/dev/null && echo "✓ APK files found" || echo "✗ No APK files found"
          echo ""
          echo "Looking for app outputs:"
          ls -laR build/app/outputs/ 2>/dev/null || echo "build/app/outputs/ directory not found"
          echo ""
          echo "Checking expected location:"
          APK_FILE="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_FILE" ]; then
            echo "✓ APK found at $APK_FILE"
            ls -lh "$APK_FILE"
            exit 0
          else
            echo "✗ APK not found at $APK_FILE"
            exit 1
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: dlai-crop-apk
          path: mobile/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            mobile/build.log
            mobile/pub-get.log
            mobile/build_runner.log
            mobile/analyzer.log
          retention-days: 7
        continue-on-error: true
