name: Mobile CI - Lint, Test, Build APK

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'mobile/**'
      - '.github/workflows/mobile-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'mobile/**'

jobs:
  build:
    name: Build, Lint, Test, and Package APK
    runs-on: ubuntu-latest
    
    outputs:
      apk_path: ${{ steps.build_apk.outputs.apk_path }}
      build_status: ${{ job.status }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Debug - Check environment
        run: |
          echo "Dart SDK version:"
          which dart
          dart --version
          echo "Flutter version:"
          which flutter
          flutter --version

      - name: Cache Flutter pub cache
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('mobile/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache Flutter build
        uses: actions/cache@v3
        with:
          path: mobile/build
          key: ${{ runner.os }}-flutter-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-

      - name: Get Flutter dependencies
        working-directory: ./mobile
        run: |
          echo "Setting up Android local.properties..."
          FLUTTER_ROOT=$(dirname $(dirname $(which flutter)))
          echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties
          echo "Created local.properties with Flutter SDK: $FLUTTER_ROOT"
          cat android/local.properties
          echo ""
          echo "Removing stale pubspec.lock if exists..."
          rm -f pubspec.lock
          echo "Running flutter pub get..."
          flutter pub get --verbose 2>&1 | tee pub-get.log
          PUB_RESULT=$?
          if [ $PUB_RESULT -ne 0 ]; then
            echo "ERROR: flutter pub get failed with exit code $PUB_RESULT"
            exit $PUB_RESULT
          fi
          echo "Dependencies resolved successfully"

      - name: Generate code (build_runner)
        working-directory: ./mobile
        run: |
          echo "Starting code generation..."
          dart run build_runner build --delete-conflicting-outputs --verbose 2>&1 | tee build_runner.log
          echo "Code generation completed"

      - name: Analyze code
        working-directory: ./mobile
        run: |
          echo "Running Flutter analyzer..."
          flutter analyze --no-fatal-infos 2>&1 | tee analyzer.log || true
          echo "Analyzer complete"
        continue-on-error: true

      - name: Check formatting
        working-directory: ./mobile
        run: dart format --set-exit-if-changed lib test
        continue-on-error: true

      - name: Run unit tests
        working-directory: ./mobile
        run: |
          if [ -d "test" ] && [ "$(find test -name '*_test.dart' -type f | grep -v placeholder)" ]; then
            echo "Running tests..."
            flutter test --coverage 2>&1 | tee test.log
          else
            echo "No real tests found, skipping test execution"
          fi
        continue-on-error: true

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./mobile/coverage/lcov.info
          flags: mobile
          name: mobile-coverage
        continue-on-error: true

      - name: Build APK (release) - ARM64
        id: build_apk
        working-directory: ./mobile
        run: |
          echo "=== Starting APK Build ==="
          flutter build apk \
            --release \
            --target-platform android-arm64 \
            --verbose 2>&1 | tee build.log
          BUILD_RESULT=$?
          echo "=== Build Exit Code: $BUILD_RESULT ==="
          if [ $BUILD_RESULT -ne 0 ]; then
            echo "BUILD FAILED! Exit code: $BUILD_RESULT"
            tail -100 build.log
            exit $BUILD_RESULT
          fi
          echo "apk_path=build/app/outputs/flutter-apk/app-release.apk" >> $GITHUB_OUTPUT
          echo "=== APK Build Completed Successfully ==="

      - name: Verify APK
        working-directory: ./mobile
        run: |
          echo "Checking for APK files..."
          APK_FILE="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_FILE" ]; then
            echo "✓ APK found at expected location"
            ls -lh "$APK_FILE"
          else
            echo "✗ ERROR: APK not found at $APK_FILE"
            echo "Searching for any APK files:"
            find build -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
            exit 1
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: dlai-crop-apk
          path: mobile/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          if-no-files-found: error

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            mobile/build.log
            mobile/pub-get.log
            mobile/build_runner.log
            mobile/analyzer.log
          retention-days: 7
        continue-on-error: true
