name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10, 3.11, 3.12]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            else
              echo "No requirements.txt found, skipping install."
            fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Lint (ruff)
        run: |
          ruff check . || true
      - name: Format check (black)
        run: |
          black --check . || true
      - name: Run tests
        run: |
          PYTHONPATH=src python -m pytest -q
      - name: Build Docker image (local, no push)
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: crop-ai:${{ github.sha }}
  deploy:
    name: Deploy to Azure Container Instances
    needs: [test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Azure Login (Service Principal)
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Set ACR credentials for Docker
        run: |
          az acr login -n $(echo ${{ secrets.ACR_LOGIN_SERVER }} | cut -d. -f1)
      - name: Build and push image to ACR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.ACR_LOGIN_SERVER }}/crop-ai:${{ github.sha }},${{ secrets.ACR_LOGIN_SERVER }}/crop-ai:latest
      - name: Deploy to Azure Container Instances
        run: |
          az container create \
            -g crop-ai-rg \
            -n crop-ai-aci-${{ github.run_number }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/crop-ai:${{ github.sha }} \
            --registry-login-server ${{ secrets.ACR_LOGIN_SERVER }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --cpu 1 \
            --memory 1 \
            --environment-variables LOG_LEVEL=INFO \
            --restart-policy OnFailure
      - name: Log deployment info
        run: |
          echo "Container deployed to Azure Container Instances"
          az container show -g crop-ai-rg -n crop-ai-aci-${{ github.run_number }} --query "{Name:name, Status:containers[0].instanceView.currentState.state, Image:containers[0].image}" -o table
