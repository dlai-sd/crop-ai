name: Mobile Build & Distribute

on:
  workflow_dispatch:
    inputs:
      upload_to_play_store:
        description: 'Upload to Play Store internal testing?'
        required: false
        default: 'false'

jobs:
  build_and_distribute:
    name: Build AAB & Distribute
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Cache Flutter pub cache
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
            ${{ runner.os }}-

      - name: Cache Flutter build
        uses: actions/cache@v3
        with:
          path: mobile/build
          key: ${{ runner.os }}-flutter-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-

      - name: Get Flutter dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Generate code (build_runner)
        working-directory: ./mobile
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build App Bundle (AAB - Release)
        working-directory: ./mobile
        run: |
          flutter build appbundle \
            --release \
            --target-platform android-arm64

      - name: Verify AAB
        working-directory: ./mobile
        run: |
          ls -lh build/app/outputs/bundle/release/
          file build/app/outputs/bundle/release/app-release.aab

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: dlai-crop-aab
          path: mobile/build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Upload to Play Store (Internal Testing)
        if: github.event.inputs.upload_to_play_store == 'true'
        env:
          PLAY_STORE_SERVICE_ACCOUNT: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT }}
        working-directory: ./mobile
        run: |
          # Install fastlane
          sudo apt-get update
          sudo apt-get install -y ruby-dev
          sudo gem install fastlane -v 2.217.0
          
          # Create service account file
          echo "$PLAY_STORE_SERVICE_ACCOUNT" > /tmp/service_account.json
          
          # Upload to Play Store (internal testing)
          fastlane supply --aab build/app/outputs/bundle/release/app-release.aab \
            --skip_upload_metadata \
            --skip_upload_images \
            --skip_upload_screenshots \
            --track internal \
            --json_key /tmp/service_account.json \
            --package_name com.dlai.crop \
            --skip_upload_metadata true
          
          # Clean up
          rm /tmp/service_account.json

      - name: Create GitHub Release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: mobile-v${{ github.run_number }}
          release_name: Mobile Build ${{ github.run_number }}
          body: |
            ## Build Information
            - Build Number: ${{ github.run_number }}
            - Triggered by: @${{ github.actor }}
            - Commit: ${{ github.sha }}
            
            ## Artifacts
            - App Bundle (AAB): Ready for Play Store
            - Built on: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
