name: Mobile Build & Distribute

on:
  workflow_dispatch:
    inputs:
      upload_to_play_store:
        description: 'Upload to Play Store internal testing?'
        required: false
        default: 'true'

jobs:
  build_and_distribute:
    name: Build & Upload to Play Store
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get Flutter dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Build APK (release)
        working-directory: ./mobile
        run: |
          flutter build apk \
            --release \
            --split-per-abi \
            --target-platform android-arm64 \
            --no-sound-null-safety

      - name: Build App Bundle (AAB)
        working-directory: ./mobile
        run: |
          flutter build appbundle \
            --release \
            --target-platform android-arm64 \
            --no-sound-null-safety

      - name: Upload to Play Store (Internal Testing)
        if: github.event.inputs.upload_to_play_store == 'true'
        env:
          PLAY_STORE_SERVICE_ACCOUNT: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT }}
        working-directory: ./mobile
        run: |
          # Install fastlane
          sudo apt-get update
          sudo apt-get install -y ruby-dev
          sudo gem install fastlane
          
          # Create service account file
          echo "$PLAY_STORE_SERVICE_ACCOUNT" > /tmp/service_account.json
          
          # Upload to Play Store
          fastlane supply --aab build/app/outputs/bundle/release/app-release.aab \
            --skip_upload_metadata \
            --skip_upload_images \
            --skip_upload_screenshots \
            --track internal \
            --json_key /tmp/service_account.json \
            --package_name com.dlai.crop
          
          # Clean up
          rm /tmp/service_account.json

      - name: Create Release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: mobile-v${{ github.run_number }}
          release_name: Mobile Build ${{ github.run_number }}
          body: |
            ## DLAI Crop Mobile - Build ${{ github.run_number }}
            
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            
            ### Artifacts
            - APK: Attached to this release
            - AAB: Uploaded to Play Store
            
            ### Notes
            This is an internal testing release.
          draft: false
          prerelease: true

      - name: Upload APK to Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          files: mobile/build/app/outputs/flutter-apk/app-release.apk
          tag_name: mobile-v${{ github.run_number }}

      - name: Notify Success
        if: success()
        run: |
          echo "✅ Build successful!"
          echo "APK: mobile/build/app/outputs/flutter-apk/app-release.apk"
          echo "AAB: mobile/build/app/outputs/bundle/release/app-release.aab"

      - name: Notify Failure
        if: failure()
        run: |
          echo "❌ Build failed!"
          exit 1
