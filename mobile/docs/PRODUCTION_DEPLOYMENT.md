# Production Deployment Guide

## Firebase Integration & Drift Database - Ready for Production

This guide provides step-by-step instructions for deploying the Crop AI mobile app to production with Firebase integration and Drift database.

---

## Phase 1: Pre-Deployment Preparation

### 1.1 Code Generation

**Generate Drift database code:**
```bash
cd /workspaces/crop-ai/mobile
flutter pub run build_runner build --delete-conflicting-outputs
```

**Expected output:**
- `lib/features/cloud_sync/data/database/app_database.g.dart` (1000+ LOC)
- `lib/features/cloud_sync/data/database/drift_types.dart`

**Verify generation:**
```bash
# Check generated files exist
ls -la lib/features/cloud_sync/data/database/app_database.g.dart
ls -la lib/features/cloud_sync/data/database/drift_types.dart

# Verify no compilation errors
flutter analyze lib/features/cloud_sync/data/
```

### 1.2 Dependencies Verification

**Required packages:**
```yaml
dependencies:
  firebase_core: ^2.24.0
  cloud_firestore: ^4.14.0
  firebase_auth: ^4.15.0
  drift: ^2.14.0
  sqlite3_flutter_libs: ^0.5.0
  path_provider: ^2.1.0
  connectivity_plus: ^5.0.0

dev_dependencies:
  build_runner: ^2.4.0
  drift_dev: ^2.14.0
```

**Install:**
```bash
flutter pub get
```

### 1.3 Configuration Setup

**Add to `main.dart`:**
```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by Firebase CLI
import 'lib/features/cloud_sync/data/firebase_config.dart';
import 'lib/features/cloud_sync/data/firebase_connection_monitor.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  // Initialize Firebase config
  await FirebaseConfig.initialize();
  
  // Initialize connection monitoring
  final monitor = FirebaseConnectionMonitor();
  await monitor.initialize();
  
  runApp(const MyApp());
}
```

---

## Phase 2: Firebase Project Setup

### 2.1 Firebase Console Configuration

1. **Create Firebase Project:**
   - Go to [Firebase Console](https://console.firebase.google.com)
   - Create new project: `crop-ai-project`

2. **Enable Services:**
   - Authentication (Email/Password)
   - Firestore Database
   - Cloud Storage (if needed)

3. **Add Apps:**
   - Android app: `com.example.cropai`
   - iOS app: `com.example.cropai`

4. **Download Configuration Files:**
   - Android: `google-services.json` → `android/app/`
   - iOS: `GoogleService-Info.plist` → `ios/Runner/`

### 2.2 Firestore Database Setup

**Create Firestore Database:**
```
Production mode (not testing)
Location: us-central1 (or your region)
```

**Create Collections:**
```
/users
/farms (with subcollections)
/user_farm_associations
/sync_logs
```

**Sample Documents:**
```
users/{userId}
├── uid: string
├── email: string
├── displayName: string
├── photoUrl: string
├── createdAt: timestamp
├── lastSignIn: timestamp
└── emailVerified: boolean

farms/{farmId}
├── id: string
├── userId: string (FK)
├── name: string
├── location: string
├── areaHectares: number
├── cropType: string
├── createdAt: timestamp
├── updatedAt: timestamp
├── metadata: map
├── version: number
├── isShared: boolean
└── sharedWith: array

user_farm_associations/{userId}-{farmId}
├── userId: string
├── farmId: string
├── associatedAt: timestamp
└── accessLevel: string

sync_logs/{eventId}
├── id: string
├── entityType: string
├── entityId: string
├── eventType: string
├── data: map
├── createdAt: timestamp
├── syncedAt: timestamp
└── conflictResolution: string
```

### 2.3 Firestore Security Rules

**Deploy security rules:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Farms: owner can read/write, shared users can read
    match /farms/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Managed via subcollections
    }

    // User-specific farms
    match /users/{userId}/farms/{farmId} {
      allow read, write: if request.auth.uid == userId;
      allow read: if exists(/databases/$(database)/documents/user_farm_associations/$(request.auth.uid)-$(farmId));
    }

    // Farm associations for sharing
    match /user_farm_associations/{document=**} {
      allow read, write: if request.auth != null;
    }

    // Sync logs
    match /sync_logs/{eventId} {
      allow write: if request.auth != null;
      allow read: if request.auth != null;
    }
  }
}
```

---

## Phase 3: Testing Before Deployment

### 3.1 Unit Tests

**Run all unit tests:**
```bash
flutter test tests/unit/
```

**Expected output:**
- ✅ offline_cache_service_test.dart
- ✅ firebase_connection_monitor_test.dart
- ✅ sync_models_test.dart (if exists)

### 3.2 Integration Tests

**Run integration tests:**
```bash
flutter test tests/integration/
```

**Key test scenarios:**
- ✅ Authentication flow (signup/signin/signout)
- ✅ Farm management (CRUD)
- ✅ Offline cache operations
- ✅ Sync operations
- ✅ Conflict resolution

### 3.3 Manual Testing Checklist

**Device Setup:**
- [ ] Test on iOS simulator
- [ ] Test on Android emulator
- [ ] Test on physical iOS device
- [ ] Test on physical Android device

**Authentication:**
- [ ] Signup creates user
- [ ] Signin authenticates
- [ ] Signout clears session
- [ ] User profile cached locally

**Farm Management:**
- [ ] Create farm
- [ ] Update farm
- [ ] Delete farm
- [ ] Share farm with user
- [ ] Accept shared farm

**Offline-First:**
- [ ] Create changes while offline
- [ ] Changes queued in Drift DB
- [ ] Go online
- [ ] Changes synced to Firebase
- [ ] Sync status updates

**Connection Monitoring:**
- [ ] Monitor shows "Connected" when online
- [ ] Monitor shows "Offline" when disconnected
- [ ] Sync readiness updates correctly
- [ ] Real-time indicators work

**Conflict Resolution:**
- [ ] Detect conflicting versions
- [ ] Show conflict UI
- [ ] Resolve conflict
- [ ] Verify resolution persisted

### 3.4 Performance Testing

**Database Performance:**
```bash
# Measure sync time
time flutter test tests/integration/firebase_sync_integration_test.dart
```

**Expected performance:**
- Event insertion: <50ms
- Batch upload (100 events): <2s
- Query pending events: <100ms
- Sync metadata update: <50ms

---

## Phase 4: Release Build

### 4.1 Android Release Build

**Create signing key:**
```bash
keytool -genkey -v -keystore ~/crop_ai_key.jks \
  -keyalg RSA -keysize 2048 -validity 10000 \
  -alias crop_ai
```

**Configure signing in `android/app/build.gradle`:**
```gradle
android {
    // ... existing config

    signingConfigs {
        release {
            keyAlias 'crop_ai'
            keyPassword 'YOUR_KEY_PASSWORD'
            storeFile file(System.getenv("HOME") + '/crop_ai_key.jks')
            storePassword 'YOUR_STORE_PASSWORD'
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
    }
}
```

**Build release APK/AAB:**
```bash
flutter build apk --release
flutter build appbundle --release
```

**Output:**
- `build/app/outputs/apk/release/app-release.apk`
- `build/app/outputs/bundle/release/app-release.aab`

### 4.2 iOS Release Build

**Configure signing in Xcode:**
```
1. Open ios/Runner.xcworkspace
2. Select Runner target
3. Go to Signing & Capabilities
4. Configure team, provisioning profile
5. Verify bundle ID matches Firebase config
```

**Build release IPA:**
```bash
flutter build ios --release
cd ios
xcodebuild -workspace Runner.xcworkspace \
  -scheme Runner \
  -configuration Release \
  -derivedDataPath build \
  -archivePath build/Runner.xcarchive \
  archive
```

---

## Phase 5: Production Deployment

### 5.1 Android Deployment (Google Play Store)

**Upload to Play Store:**
```
1. Go to Google Play Console
2. Create new app "Crop AI"
3. Upload build:
   - Internal testing → Staging → Production
4. Configure store listing:
   - Name, description
   - Screenshots, promo graphics
   - Permissions
   - Privacy policy
5. Submit for review
```

**Expected review time:** 2-4 hours

### 5.2 iOS Deployment (Apple App Store)

**Upload to App Store:**
```
1. Go to App Store Connect
2. Create new app "Crop AI"
3. Upload build:
   - TestFlight → App Store
4. Configure app info:
   - Name, subtitle, description
   - Screenshots, preview
   - Keywords, category
   - Privacy policy
5. Submit for review
```

**Expected review time:** 1-3 days

### 5.3 Firebase Production Settings

**Configure Firebase for production:**

```bash
# Set production Firestore rules
firebase deploy --only firestore:rules

# Configure authentication methods
firebase deploy --only auth

# Enable metrics
firebase deploy --only monitoring
```

---

## Phase 6: Post-Deployment Monitoring

### 6.1 Firebase Monitoring

**Monitor key metrics:**
```
Dashboard:
- Authentication: Sign-ups, Active Users
- Firestore: Read/Write ops, storage
- Performance: Latency, error rates
- Crashlytics: Crash reports
```

**Setup alerts:**
```
High error rate: >5%
High latency: >2s average
Authentication failures: >10%
Database quota: >80%
```

### 6.2 Application Monitoring

**Key metrics to track:**
- Sync success rate
- Offline cache hit rate
- Conflict resolution rate
- User engagement
- Crash reports

**Commands:**
```bash
# View Firebase metrics
firebase functions:log

# View Crashlytics
firebase crashlytics

# View Performance
firebase performance
```

### 6.3 Rollback Plan

**If issues detected:**

```bash
# 1. Identify issue
# 2. Prepare hotfix
# 3. Test thoroughly
# 4. Deploy new version:

flutter build apk --release  # or iOS
# Upload to store with version bump

# 5. Monitor for stability
# 6. Communicate with users
```

---

## Phase 7: Maintenance & Updates

### 7.1 Regular Tasks

**Weekly:**
- [ ] Check error logs
- [ ] Review performance metrics
- [ ] Monitor user feedback

**Monthly:**
- [ ] Update dependencies
- [ ] Run security audit
- [ ] Analyze usage patterns
- [ ] Plan new features

**Quarterly:**
- [ ] Major version updates
- [ ] Database optimization
- [ ] Security review
- [ ] Architecture improvements

### 7.2 Update Process

**For minor updates:**
```bash
# 1. Make changes
# 2. Run all tests
# 3. Update version in pubspec.yaml
# 4. Build release
# 5. Upload to stores
# 6. Monitor metrics
```

**For major updates:**
```bash
# 1-6. Same as minor
# 7. Plan gradual rollout (% users)
# 8. Monitor each stage
# 9. Adjust Firebase rules if needed
# 10. Full rollout when stable
```

### 7.3 Backup & Recovery

**Database backups:**
```bash
# Firestore automatic backups (GCP)
# Enable in Firestore console
# Location: us-central1
# Frequency: Daily
# Retention: 7 days
```

**Local database:**
```bash
# iOS: Document backup
# Android: Database backup
# User can restore from backup
```

---

## Deployment Checklist

### Pre-Deployment
- [ ] Code generation complete (build_runner)
- [ ] All tests passing
- [ ] No lint warnings
- [ ] Dependencies updated
- [ ] Firebase project created
- [ ] Configuration files added
- [ ] Firestore collections created
- [ ] Security rules deployed

### Deployment
- [ ] Android release build
- [ ] iOS release build
- [ ] Stores configured
- [ ] Privacy policy added
- [ ] Screenshots/graphics uploaded
- [ ] Version numbers updated
- [ ] Release notes written

### Post-Deployment
- [ ] Apps published
- [ ] Monitoring active
- [ ] Alerts configured
- [ ] Team notified
- [ ] User communication sent
- [ ] Support team trained

### Maintenance
- [ ] Daily: Check errors
- [ ] Weekly: Review metrics
- [ ] Monthly: Plan updates
- [ ] Quarterly: Major review

---

## Troubleshooting

### Build Issues

**Drift code generation fails:**
```bash
flutter clean
flutter pub get
flutter pub run build_runner build --delete-conflicting-outputs
```

**Firebase initialization error:**
```
Verify google-services.json/GoogleService-Info.plist in correct location
Check Firebase project ID matches
Ensure services are enabled in Firebase console
```

**Test failures:**
```bash
flutter test --verbose
# Check error messages
# Verify mock data setup
# Check database initialization
```

### Runtime Issues

**Connection failures:**
```
Check internet connectivity
Verify Firebase status page
Check Firestore rules
Review network logs
```

**Sync failures:**
```
Check pending events in database
Verify Firestore has space
Check user permissions
Review error logs in Firebase
```

**UI issues:**
```
Verify connection monitor initialization
Check stream subscriptions
Ensure UI rebuilds on state changes
Review error handling
```

---

## Support & Documentation

**Resources:**
- [Firebase Documentation](https://firebase.flutter.dev/)
- [Drift Database Docs](https://drift.simonbinder.eu/)
- [Flutter Deployment Guide](https://flutter.dev/docs/deployment)
- [Google Play Console Help](https://support.google.com/googleplay/android-developer)
- [App Store Connect Help](https://help.apple.com/app-store-connect/)

**Contact:**
- Technical Issues: [GitHub Issues](https://github.com/dlai-sd/crop-ai/issues)
- Feature Requests: [GitHub Discussions](https://github.com/dlai-sd/crop-ai/discussions)
- Security Issues: security@cropai.dev

---

**Ready for Production:** ✅
**Deployment Branch:** epic/3-analytics
**Build Date:** Current Session
**Next Release:** After QA approval
